<!DOCTYPE html><html>
<head>

    <script src="js/bin/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="js/bin/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="js/bin/sonantx.js"></script>
    <script type="text/javascript" src="js/level.js"></script>
    <script type="text/javascript" src="js/block.js"></script>
    <!--<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">-->
    <!-- <link href="//fonts.googleapis.com/css?family=Lobster&subset=latin,latin-ext" rel="stylesheet" type="text/css"> -->
    <link href="css/CreazyGame.css" rel="stylesheet">

</head>
<body>

<div id="cont">
    <input id="username" placeholder="Enter a user name" type="text" name="username" onfocus="$.canEdit=true;" onblur="$.gameProgress.saveUser(this.value);$.canEdit=false;" onkeydown="if (event.keyCode == 13)
                        {this.blur();}">
    <div id="game">
        <div id="blockContainer"></div>
        <div id="bob">
            <!--<div class="head">-->
                <!--<div id="eyeLeft" class="eye"></div>-->
                <!--<div id="eyeRight" class="eye"></div>-->
                <!--<div id="browLeft" class="brow"></div>-->
                <!--<div id="browRight" class="brow"></div>-->
            <!--</div>-->
            <div id="bobody">
                <div class="body">
                    <!--<svg version="1.1" width="95" height="115" viewBox="-20 -70 85 130" xmlns="http://www.w3.org/2000/svg">-->
                        <!--<path fill="#808080" stroke="#000000" stroke-width="1" d="M33,1.167v7.499C34.667,45.5,1.667,43.5,1.667,43.5l0.323-7.508C27,38.333,24,14.166,24,14.166H1.667L2,1.167H33z" />-->
                    <!--</svg>-->
                </div>
            </div>
        </div>
        <div id="ghost">
            <div class="head">
                <div id="eyeLeft" class="eye"></div>
                <div id="eyeRight" class="eye"></div>
                <div id="browLeft" class="brow"></div>
                <div id="browRight" class="brow"></div>
            </div>
            <div class="body">
                <!--<svg version="1.1" width="95" height="115" viewBox="-20 -70 85 130" xmlns="http://www.w3.org/2000/svg">-->
                    <!--&lt;!&ndash;<path fill="#808080" stroke="#000000" stroke-width="1" d="M33,1.167v7.499C34.667,45.5,1.667,43.5,1.667,43.5l0.323-7.508C27,38.333,24,14.166,24,14.166H1.667L2,1.167H33z" />&ndash;&gt;-->
                <!--</svg>-->
            </div>
        </div>
        <canvas id="main"></canvas>
        <div id="my-gui-container" class="right bigText"></div>
    </div>
    <div id="overlay"></div>
    <div id="effect"></div>
</div>
</body>
<script>
    $.key = {
        left: 0,
        right: 0,
        up: 0,
        space: 0
    };

    $.offset = {
        x: 0,
        y: 0
    };

    $.dt = 0;
    $.lt = 0;
    $.elapsed = 0;
    $.mute = 0;
    $.glitch = 0;
    $.canEdit = false;

    $.ios = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    $.state;

    // 定义屏幕长宽
    $.W = Math.min(window.innerWidth, 900);
    $.H = Math.min(window.innerHeight, 700);


    $.setup = function() {
        $.main = document.getElementById('main');
        $.mainctx = $.main.getContext('2d');
        // 读取之前的记录
        $.gameProgress = new $.gameLoad();

        $.main.width = $.W;
        $.main.height = $.H;

        $.sounds = [];

        if (window.AudioContext) {
            $.audioCtx = new AudioContext();

            // Sonant-X 利用这个js库来创建一些音效
            var soundGen = new sonantx.SoundGenerator($.jumpInstrument);
            // 147代表C5调，然后就类推（反正也不懂，瞎试声音好了）
            soundGen.createAudioBuffer(137, function(buffer) {
                $.sounds['jump'] = buffer;
            });
            soundGen.createAudioBuffer(157, function(buffer) {
                $.sounds['bounce'] = buffer;
            });
            soundGen.createAudioBuffer(134, function(buffer) {
                $.sounds['bounce1'] = buffer;
            });

            soundGen.createAudioBuffer(117, function(buffer) {
                $.sounds['bounce2'] = buffer;
            });

            soundGen.createAudioBuffer(127, function(buffer) {
                $.sounds['bounce3'] = buffer;
            });
            soundGen.createAudioBuffer(105, function(buffer) {
                $.sounds['bounce4'] = buffer;
            });
        }


        // 事件监听
        window.addEventListener('keydown', $.keydown, false);
        window.addEventListener('keyup', $.keyup, false);
        window.addEventListener('touchstart', $.touchstart);
        window.addEventListener('touchmove', $.touchmove);
        window.addEventListener('touchend', $.touchend);

        $.state = new $.play();
        $.state.init();
        $.loop();
    };


    $.playSound = function(b, l) {
        if (!$.mute && window.AudioContext) {
            var source = $.audioCtx.createBufferSource();

            source.buffer = b;
            source.connect($.audioCtx.destination);

            source.start(0);
            return source;
        }


    };


    $.keydown = function(e) {
        if (!$.canEdit) {
            e.preventDefault()
        }
        if (e.keyCode === 37) {
            $.key.left = 1;
        }
        if (e.keyCode === 39) {
            $.key.right = 1;
        }
        if (e.keyCode === 32) {
            $.key.space = 1;
        } //32
        if (e.keyCode === 13) {
            $.key.enter = 1;
        }
    };

    $.keyup = function(e) {

        if (e.keyCode === 37) {
            $.key.left = 0;
        }
        if (e.keyCode === 39) {
            $.key.right = 0;
        }
        if (e.keyCode === 32) {
            $.key.space = 0;
        }
        if (e.keyCode === 13) {
            $.key.enter = 0;
        }
    };

    $.touchstart = function(e) {
        if (e.target.id === "overlay" || e.target.id === "body") {
            e.preventDefault()
        }
        // var action = e.target.dataset.action;
        //		if (action) {
        var i = 0;
        while (i < e.touches.length) {
            p = e.touches[i];
            if (p.clientX < window.innerWidth / 4) {
                $.key.left = 1;
            }
            if (p.clientX > window.innerWidth - (window.innerWidth / 2)) {
                $.key.space = 1;
            }
            if (p.clientX > window.innerWidth / 4 && p.clientX < 2 * (window.innerWidth / 4)) {
                $.key.right = 1;
            }
            i++;
        }

    };

    $.touchend = function(e) {
        if (e.target.id === "overlay" || e.target.id === "body") {
            e.preventDefault()
        }
        $.key.left = 0;
        $.key.right = 0;
        $.key.space = 0;
    };

    $.touchmove = function(e) {
        e.preventDefault();
    };

    $.updateDelta = function() {
        var now = Date.now();
        $.dt = (now - $.lt) / (1000 / 60);
        $.lt = now;
        $.elapsed += $.dt / 60;
    };


    $.loop = function() {
        //  setTimeout(function () {
        window.requestAnimFrame($.loop);
        $.update();
        $.render();
        //  }, 1000 / 60);
    };

    $.update = function() {
        $.updateDelta();
        $.state.update();
    };

    $.render = function() {
        $.mainctx.clearRect(0, 0, $.W, $.H);
        $.state.render();

    };


    window.addEventListener('load', function() {
        $.setup();
    });

    $.jumpInstrument = {
        "osc1_oct": 9,
        "osc1_det": 0,
        "osc1_detune": 0,
        "osc1_xenv": 0,
        "osc1_vol": 188,
        "osc1_waveform": 0,
        "osc2_oct": 9,
        "osc2_det": 0,
        "osc2_detune": 12,
        "osc2_xenv": 0,
        "osc2_vol": 186,
        "osc2_waveform": 0,
        "noise_fader": 0,
        "env_attack": 100,
        "env_sustain": 0,
        "env_release": 14545,
        "env_master": 70,
        "fx_filter": 0,
        "fx_freq": 0,
        "fx_resonance": 240,
        "fx_delay_time": 2,
        "fx_delay_amt": 157,
        "fx_pan_freq": 3,
        "fx_pan_amt": 47,
        "lfo_osc1_freq": 0,
        "lfo_fx_freq": 0,
        "lfo_freq": 0,
        "lfo_amt": 0,
        "lfo_waveform": 0
    };

    /*
    $.song = {
        "rowLen": 6014,
        "endPattern": 8,
        "songData": [
            {
                "osc1_oct": 7,
                "osc1_det": 0,
                "osc1_detune": 0,
                "osc1_xenv": 1,
                "osc1_vol": 255,
                "osc1_waveform": 0,
                "osc2_oct": 7,
                "osc2_det": 0,
                "osc2_detune": 0,
                "osc2_xenv": 1,
                "osc2_vol": 255,
                "osc2_waveform": 0,
                "noise_fader": 0,
                "env_attack": 50,
                "env_sustain": 150,
                "env_release": 4800,
                "env_master": 200,
                "fx_filter": 2,
                "fx_freq": 600,
                "fx_resonance": 254,
                "fx_delay_time": 0,
                "fx_delay_amt": 0,
                "fx_pan_freq": 0,
                "fx_pan_amt": 0,
                "lfo_osc1_freq": 0,
                "lfo_fx_freq": 0,
                "lfo_freq": 0,
                "lfo_amt": 0,
                "lfo_waveform": 0,
                "p": [
                    1,
                    1,
                    1,
                    1,
                    1,
                    1,
                    1
                ],
                "c": [
                    {
                        "n": [
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0,
                            142,
                            0,
                            0,
                            0
                        ]
                    }
                ]
            },
            {
                "osc1_oct": 8,
                "osc1_det": 0,
                "osc1_detune": 0,
                "osc1_xenv": 0,
                "osc1_vol": 0,
                "osc1_waveform": 0,
                "osc2_oct": 8,
                "osc2_det": 0,
                "osc2_detune": 0,
                "osc2_xenv": 0,
                "osc2_vol": 0,
                "osc2_waveform": 0,
                "noise_fader": 60,
                "env_attack": 50,
                "env_sustain": 419,
                "env_release": 4607,
                "env_master": 130,
                "fx_filter": 1,
                "fx_freq": 10332,
                "fx_resonance": 120,
                "fx_delay_time": 4,
                "fx_delay_amt": 16,
                "fx_pan_freq": 5,
                "fx_pan_amt": 108,
                "lfo_osc1_freq": 0,
                "lfo_fx_freq": 0,
                "lfo_freq": 5,
                "lfo_amt": 187,
                "lfo_waveform": 0,
                "p": [
                    0,
                    0,
                    0,
                    3,
                    3,
                    3
                ],
                "c": [
                    {
                        "n": [
                            165,
                            164,
                            164,
                            0,
                            0,
                            0,
                            0,
                            0,
                            50,
                            75,
                            72,
                            68,
                            68,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    {
                        "n": [
                            165,
                            164,
                            164,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            56,
                            65,
                            65,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0
                        ]
                    },
                    {
                        "n": [
                            125,
                            0,
                            0,
                            0,
                            116,
                            0,
                            0,
                            0,
                            106,
                            0,
                            0,
                            0,
                            125,
                            0,
                            0,
                            0,
                            116,
                            0,
                            0,
                            0,
                            106,
                            0,
                            0,
                            0,
                            125,
                            0,
                            0,
                            0,
                            116,
                            0,
                            0,
                            0
                        ]
                    }
                ]
            },
            {
                "osc1_oct": 6,
                "osc1_det": 0,
                "osc1_detune": 0,
                "osc1_xenv": 1,
                "osc1_vol": 255,
                "osc1_waveform": 0,
                "osc2_oct": 6,
                "osc2_det": 0,
                "osc2_detune": 0,
                "osc2_xenv": 1,
                "osc2_vol": 255,
                "osc2_waveform": 0,
                "noise_fader": 14,
                "env_attack": 50,
                "env_sustain": 150,
                "env_release": 8181,
                "env_master": 161,
                "fx_filter": 2,
                "fx_freq": 5900,
                "fx_resonance": 240,
                "fx_delay_time": 6,
                "fx_delay_amt": 66,
                "fx_pan_freq": 0,
                "fx_pan_amt": 0,
                "lfo_osc1_freq": 0,
                "lfo_fx_freq": 0,
                "lfo_freq": 0,
                "lfo_amt": 0,
                "lfo_waveform": 0,
                "p": [
                    0,
                    0,
                    1,
                    1,
                    1,
                    1,
                    1
                ],
                "c": [
                    {
                        "n": [
                            135,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            151,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            116,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            151,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0
                        ]
                    }
                ]
            },
            {
                "osc1_oct": 8,
                "osc1_det": 0,
                "osc1_detune": 0,
                "osc1_xenv": 0,
                "osc1_vol": 0,
                "osc1_waveform": 0,
                "osc2_oct": 8,
                "osc2_det": 0,
                "osc2_detune": 0,
                "osc2_xenv": 0,
                "osc2_vol": 0,
                "osc2_waveform": 0,
                "noise_fader": 60,
                "env_attack": 50,
                "env_sustain": 419,
                "env_release": 4607,
                "env_master": 130,
                "fx_filter": 1,
                "fx_freq": 10332,
                "fx_resonance": 120,
                "fx_delay_time": 4,
                "fx_delay_amt": 16,
                "fx_pan_freq": 5,
                "fx_pan_amt": 108,
                "lfo_osc1_freq": 0,
                "lfo_fx_freq": 0,
                "lfo_freq": 5,
                "lfo_amt": 187,
                "lfo_waveform": 0,
                "p": [
                    1,
                    1,
                    1,
                    1,
                    1,
                    1,
                    1
                ],
                "c": [
                    {
                        "n": [
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0,
                            0,
                            0,
                            130,
                            0
                        ]
                    }
                ]
            },
            {
                "osc1_oct": 8,
                "osc1_det": 0,
                "osc1_detune": 0,
                "osc1_xenv": 1,
                "osc1_vol": 221,
                "osc1_waveform": 0,
                "osc2_oct": 8,
                "osc2_det": 0,
                "osc2_detune": 0,
                "osc2_xenv": 1,
                "osc2_vol": 210,
                "osc2_waveform": 0,
                "noise_fader": 33,
                "env_attack": 50,
                "env_sustain": 150,
                "env_release": 15454,
                "env_master": 196,
                "fx_filter": 3,
                "fx_freq": 11024,
                "fx_resonance": 240,
                "fx_delay_time": 6,
                "fx_delay_amt": 24,
                "fx_pan_freq": 0,
                "fx_pan_amt": 20,
                "lfo_osc1_freq": 0,
                "lfo_fx_freq": 1,
                "lfo_freq": 7,
                "lfo_amt": 64,
                "lfo_waveform": 0,
                "p": [
                    1,
                    0,
                    1,
                    0,
                    0,
                    1
                ],
                "c": [
                    {
                        "n": [
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            0,
                            149,
                            147,
                            147,
                            147,
                            147
                        ]
                    }
                ]
            }
        ],
        "songLen": 37
    }*/
    // $.glitchType = ['walk', 'grab', 'blink', 'flatten', 'bounce', 'Rexpress'];

//    $.tutorial = [
//        ["Stop all this glitch madness of JS13k!", "Quickly return me, a semicolon, to the braketed finish.", "The faster you are, the more notoriety you'll receive!", $.ios ? "Use the left half of the screen to move left or right" : "Left and right arrows make me move.", $.ios ? "Use the right half of the screen to jump" : "Space makes me jump and enter restarts me.", "Let's go! Time's a wasting up there!"], //level 0
//        ["This time we have bounce strips.", "Hurry! Jump on them and find the bracketed finish."],
//        ["Floating ground, hmm?", "I can't jump through these.", "And those blue ones look slippery."],
//        ["Padded walls?!? Do I look looney?", "Maybe I can climb them?"],
//        ["What's that red wall up there?", $.ios ? "Use the left half of the screen" : "Press left or right on the arrow keys,", "and I can slide on it."],
//        ["Sideways bouncy strips...", "Looks like a bouncy house.", "Let's see what these can do!"]
//    ];

    $.util = {};

    window.requestAnimFrame = (function() {
        return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function(callback) {
                window.setTimeout(callback, 1000 / 60);
            };
    })();


    // 读取之前的数据 用localStorage来存储的好处就是，比cookie大，可以存5M的
    $.gameLoad = function() {
        this.data = {};
        this.data.scores = [];
        this.data.user = "default user";


        var opt = JSON.parse(localStorage.getItem("Storage"));
        // console.log(opt);

        // 新建或者读取
        if (opt === null) {
            localStorage.setItem("Storage", JSON.stringify(this.data));
        }
        else {
            this.data.scores = opt.scores;
            this.data.user = opt.user;
        }


        this.saveUser = function(name) {
            this.data.user = name;
            localStorage.setItem("Storage", JSON.stringify(this.data));
        };

        this.saveScore = function(level, scores) {
            console.log(this.data);
            if (this.data.scores.length <= level) {
                this.data.scores.push([]);
            }
            this.data.scores[level].push({
                n: this.data.user,
                s: Number(scores)
            });
            this.data.scores[level] = this.data.scores[level].sort(function(a, b) {
                if (a.s > b.s) {
                    return 1;
                }
                if (a.s < b.s) {
                    return -1;
                }
                return 0;
            });
            // 只存前5
            this.data.scores[level].splice(5, this.data.scores[level].length);
            localStorage.setItem("Storage", JSON.stringify(this.data));
        }

    };



    $.util.rectInRect = function(r1, r2) {
        return !(r2.x > r1.x + r1.w ||
            r2.x + r2.w < r1.x ||
            r2.y > r1.y + r1.h ||
            r2.y + r2.h < r1.y);
    };

    $.util.range = function(n, r) {
        if (n < 0) {
            return Math.max(n, -r);
        } else if (n > 0) {
            return Math.min(n, r);
        }
    };

    $.util.popChat = function(_x, _y, _text, _c) {

        var textEl = document.createElement('div');
        textEl.classList.add(_c || 'ani', 'note'); // could add animation option for diff behavior.

        var current = 0;
        setLocation(_text[current].length);
        textEl.innerText = _text[current];

        textEl.addEventListener("animationend", AnimationEnded, false);

        document.body.appendChild(textEl);

        function setLocation(textLength) {
            var x = textLength < 20 ? (textLength * 15) / 4 : 80; //100 is max width of box, 10 is text size
            var y = 15 + Math.ceil(textLength * .1) * 7; //100 is max width of box, 10 is text size
            textEl.style.left = (_x - x) + "px";
            textEl.style.top = (_y - y) + "px";
        }

        function AnimationEnded() {
            if (current < _text.length - 1) {
                current++;
                setLocation(_text[current].length);
                textEl.innerText = _text[current];;
                textEl.classList.remove(_c || 'ani');
                void textEl.offsetWidth;
                textEl.classList.add(_c || 'ani');
            } else {
                document.body.removeChild(textEl);
            }
        }
    };

    $.block = function(opt) {
        for (var e in $.blockBehaviors[$.blocks[opt.t].id]) {
            this[e] = $.blockBehaviors[$.blocks[opt.t].id][e];
        }
        for (var e in opt) { //level defs will over right defaults in block behaviors
            this[e] = opt[e];
        }

        this.add = this.add || function() {};
        this.style = this.style || "cube";
        this.init = this.init || function() {};
        this.x = this.x || 100;
        this.y = this.y || 100;

        this.w = this.w || 160;
        this.h = this.h || 40;

        var htmlOBJ = document.createElement('div');
        var container = document.getElementById('blockContainer');

        var status = true;
        htmlOBJ.className = this.style;

        this.init();
        htmlOBJ.style.width = this.w + 'px';
        htmlOBJ.style.height = this.h + 'px';
        if (opt.t === 4) {
            htmlOBJ.innerHTML = "<div class='func lFunc'>{</div><div class='func rFunc'>}</div>";
        }
        container.appendChild(htmlOBJ);


        this.transition = function() {
            htmlOBJ.style.transition = "all 0s";
        };

        this.kill = function() {
            container.removeChild(htmlOBJ);
        };

        this.render = function() {

            htmlOBJ.style.transform = "translate(" + ($.offset.x + this.x) + "px," + ($.offset.y + this.y) + "px)";
        }
    };

    $.ghost = function(_p, _x, _y) {
        var htmlOBJ = document.getElementById("ghost");
        this.x = _x || 350;
        this.y = _y || 650;
        var currFrame = 0;
        var path = _p || [];
        var index = 0;
        // path.splice(0, 1);

        if (path.length === 0) {
            htmlOBJ.style.display = "none";
        } else {
            htmlOBJ.style.display = "block";
        }

        this.update = function() {
            currFrame += 1;
            if (path.length > index) {

                if (path[index].f === currFrame) {
                    this.x -= path[index].x;
                    this.y -= path[index].y;
                    index += 1;
                }
            }
        };

        this.render = function() {
            htmlOBJ.style.transform = "translate(" + ($.offset.x + this.x) + "px," + ($.offset.y + this.y) + "px)";
        }
    };

    $.player = function() {
        this.htmlOBJ = document.getElementById("bob");
        this.eyelOBJ = document.getElementById("eyeLeft");
        this.eyerOBJ = document.getElementById("eyeRight");
        this.bodyOBJ = document.getElementById("bobody");
        this.x = 600;
        this.y = 710;
        this.weight = 1;

        this.velocityY = 0;
        this.velocityX = 0;

        this.latMovement = 1; //5;

        this.maxJumpHeight = 30;
        this.w = 30;
        this.h = 80;
        this.gravity = -15;

        this.lastJump = 0;
        this.currjump = 0;

        this.lastVX = 0;

        this.status = true;
        this.htmlOBJ.style.left = $.W / 2 + "px";
        this.htmlOBJ.style.top = $.H / 2.5 + "px";
    }


    $.player.prototype.reset = function() {
        this.weight = 1;
        this.velocityY = 0;
        this.velocityX = 0;
        this.eyelOBJ.style.left = "7px";
        this.eyerOBJ.style.left = "23px";
        this.htmlOBJ.style.transform = "rotate(0deg) rotateY(0deg)";

        this.status = true;
    };

    $.player.prototype.jump = function() {
        this.velocityY = this.maxJumpHeight;
        $.playSound($.sounds['jump']);
    };

    $.player.prototype.moveLeft = function() {
        if (this.velocityX > -7) {
            this.velocityX -= this.latMovement;
        }
    };


    $.player.prototype.moveRight = function() {
        if (this.velocityX < 7) {
            this.velocityX += this.latMovement;
        }

    };

    $.player.prototype.checkCollision = function(objs) {
        var _objs = [];
        var i = objs.length;
        while (i--) {
            if ($.util.rectInRect(this, objs[i])) {
                _objs.push({
                    hit: true,
                    e: objs[i]
                });
            }
        }
        return _objs;
    };

    $.player.prototype.addAnim = function(type) {
        if (type && type !== "success") {
            if (type.substring(0, 4) === "walk" && this.bodyOBJ.className === type) {
                return;
            }
            this.bodyOBJ.className = "";
            void this.bodyOBJ.offsetWidth;
            if (type) {
                this.bodyOBJ.classList.add(type)
            }
        }
        else {
            this.htmlOBJ.className = "";
            void this.htmlOBJ.offsetWidth;
            if (type) {
                this.htmlOBJ.classList.add(type)
            }
        }

    };

    $.player.prototype.success = function() {
        this.status = false;
        this.addAnim('success');
        $.state.nextLevel();
        $.util.popChat(window.innerWidth / 2, ($.H / 2.5) - 25, ["BOOOOOYAH!!!!"]);

        this.htmlOBJ.addEventListener("animationend", AnimationEnded, false);

        function AnimationEnded(e) {
            if (e.animationName === "success") {
                //  $.state.destroy();
                $.state.showSelecter();
                e.currentTarget.removeEventListener("animationend", AnimationEnded, false);
            }

        }
    };

    $.player.prototype.update = function(objs) {
        if (!this.status) {
            return
        }

        this.lastJump = this.currjump;
        this.currjump = $.key.space;
        var doJump = !!(this.lastJump === 0 & this.currjump === 1);

        if ($.key.left) {
            this.moveLeft();
        } else if ($.key.right) {
            this.moveRight();
        }


        var collide = this.checkCollision(objs);

        var i = collide.length;
        while (i--) {
            if (collide[i].hit) {

                collide[i].e.ontouch();
                if (doJump) {
                    this.jump();
                    this.addAnim('bounce');
                    collide[i].e.add();
                }


            }
        }

        if (this.velocityY > this.gravity) { //-15 is limit of drop speed  && !collide.hit
            this.velocityY -= this.weight;

        }
        if (this.lastVX !== this.velocityX.toFixed(1)) {
            // mostly animating the character here//////
            if (this.velocityY >= 0 && this.velocityY <= 1) {
                if (this.velocityX < 1.5 && this.velocityX > -1.5) {
                    ///remove walk if not moving and not in the air
                    if (this.bodyOBJ.className.substring(0, 4) === "walk") {
                        this.bodyOBJ.className = ""
                    }
                } else if (this.velocityX < 0) {
                    //do walk left if moving and not in the air
                    $.myplayer.addAnim('walk');
                } else if (this.velocityX > 0) {
                    //do walk right if moving and not in the air
                    $.myplayer.addAnim('walkR');
                }
            }

            this.eyelOBJ.style.left = (7 + (this.velocityX.toFixed(2) / 2)) + "px";
            this.eyerOBJ.style.left = (23 + (this.velocityX.toFixed(2) / 2)) + "px";
            this.htmlOBJ.style.transform = "rotate(" + $.util.range(this.velocityX.toFixed(1) * 2, 21) + "deg) rotateY(" + $.util.range(this.velocityX.toFixed(1) * 6, 40) + "deg)";
        }
        this.lastVX = this.velocityX.toFixed(1);
        ///////////////////////////////////////////////////
        this.y -= this.velocityY;
        this.x += this.velocityX;
    };

    $.play = function(l) {
        var customContainer = document.getElementById('my-gui-container');
        var timer = "0.00";

        var selecter = new $.select();

        $.myplayer = new $.player();

        var currentLevel = l || 0;
        this.path = [];

        var lastMove = {
            x: 0,
            y: 0
        };


        var status = false;
        var currFrame = 0;
        var blocks = [];
        // var song;
        var ghost;
        // var coderEnemy = new $.coder().render();

        this.init = function() {
            selecter.init();
        };

        // 建立关卡
        this.buildLevel = function(_i, _g) {

            this.destroy();
            var l = _i;
            currentLevel = l;
            var levelInfo = $.level[l].b;
            for (var i = 0; i < levelInfo.length; i++) {
                blocks.push(new $.block(levelInfo[i]));
            }

            $.myplayer.x = $.level[l].p.x;
            $.myplayer.y = $.level[l].p.y;

            $.myplayer.reset();

            $.offset = {
                x: (($.W / 2) - $.myplayer.x),
                y: (($.H / 2.5) - $.myplayer.y)
            };

        };

        this.start = function(l) {
            for (var i = 0; i < blocks.length; i++) {
                blocks[i].transition();

            }
            $.elapsed = 0;
            currFrame = 0;

            status = true;

            // song = $.playSound($.songs['a'], true);

            // build play menu
            // if (song) { song.stop(); }
            customContainer.innerHTML = "";
            var pause = document.createElement('div');
            pause.innerText = "||";
            pause.addEventListener('click', function() {
                $.myplayer.addAnim();
                $.state.clearTuts();
                status = false;
                customContainer.innerHTML = "";
                $.state.showSelecter();
            });
            customContainer.appendChild(pause);
            //////////////////////////////

            //start tutorial if needed////////////////
//            if ($.tutorial.length > l) {
//                $.util.popChat(window.innerWidth / 2, ($.H / 2.5) - 25, $.tutorial[l], 'tut');
//            }
            ///////////////////////////////////////

            ghost = new $.ghost(selecter.ghost(), $.myplayer.x, $.myplayer.y);

        };

        this.showSelecter = function() {
            selecter = new $.select(Math.min(currentLevel, $.level.length - 1));
            selecter.init();
        };


        this.destroy = function() {
            status = false;
            for (var i = 0; i < blocks.length; i++) {
                blocks[i].kill();

            }
            blocks = [];
            this.path = [];

            this.clearTuts();

            customContainer.innerHTML = "";

            // if (song) { song.stop(); }

        };

        this.clearTuts = function() {
            var removeNotes = document.getElementsByClassName("note tut");
            i = removeNotes.length;
            while (i--) {
                document.body.removeChild(removeNotes[i]);
            }
        };

        this.nextLevel = function() {
            status = false; // stop the timer and updating
            //  if (song) { song.stop(); }

            this.clearTuts(); //clear tuts on success

            customContainer.innerHTML = ""; //don't allow pausing

            this.path.splice(0, 1);
            $.gameProgress.saveScore(currentLevel, $.elapsed.toFixed(2));
            // $.onlineNewScore(currentLevel, { n: $.gameProgress.data.user||"no name mcgee", s: $.elapsed.toFixed(2) }, this.path);
            // $.socket.emit("new score", { n: $.gameProgress.data.user||"no name mcgee", l: currentLevel, s: $.elapsed.toFixed(2) }, this.path);
            //   this.path = [];

            currentLevel += 1;
        };

        this.status = function() {
            return status;
        };

        this.update = function() {
            if (status) {
                timer = $.elapsed.toFixed(2);
                // $.replaceHTML(document.getElementById('timer'), $.elapsed.toFixed(2));
                //   timer.innerHTML = $.elapsed.toFixed(2);
                $.myplayer.update(blocks);
                currFrame += 1;

                $.offset = {
                    x: (($.W / 2) - $.myplayer.x),
                    y: (($.H / 2.5) - $.myplayer.y)
                };
                ghost.update();
                if (lastMove && (Math.round(lastMove.x) !== Math.round($.offset.x) || Math.round(lastMove.y) !== Math.round($.offset.y))) {
                    this.path.push({
                        f: currFrame,
                        x: $.offset.x - lastMove.x,
                        y: $.offset.y - lastMove.y
                    });
                }
                lastMove = $.offset;

                if ($.key.enter) {
                    $.state.destroy();
                    $.state.buildLevel(currentLevel, selecter.ghost());
                    $.state.start(currentLevel);
                }
            }
        }

        this.render = function() {
            if (ghost) {
                ghost.render();
            }
            i = blocks.length;
            while (i--) {
                blocks[i].render();
            }
            //   coderEnemy.render();
            $.mainctx.fillStyle = "white";
            $.mainctx.font = "50px 'Open Sans', sans-serif";
            $.mainctx.fillText(timer, ($.W / 2) - 50, 50);

        }
        //selecter.init();
    };

    // 初始化界面，
    $.select = function(_l) {
        document.getElementById('game').classList.add("miaoMe");

        var customContainer = document.getElementById('overlay');
        var levelNum = _l || Math.min($.gameProgress.data.scores.length, $.level.length - 1);
        // console.log($.gameProgress.data.scores.length);

        var ghostPath = [];

        var levelName = document.createElement('div');

        var mid = document.createElement('div');
        mid.style.position = "relative";
        mid.style.top = "20%";

        levelName.classList.add('bigText');
        levelName.innerText = "Level " + levelNum;
        mid.appendChild(levelName);


        var scoreBoardType = "local";

        lB = document.createElement('div');
        lB.classList.add('bigText', 'links');
        // lB.innerHTML = "<b>Local</b>";
        // lB.addEventListener('click', function () { if (scoreBoardType == "online") { scoreBoardType = "local"; changeLevel(); } else { scoreBoardType = "online"; changeLevel(); } });
        mid.appendChild(lB);

        var prev = document.createElement('div');
        prev.innerText = "<";
        prev.classList.add('links', 'leftArrow');
        prev.addEventListener('click', function() {
            if (levelNum > 0) {
                levelNum--;
                $.state.buildLevel(levelNum);
            }
            changeLevel();
        });
        customContainer.appendChild(prev);


        var Scores = document.createElement('div');
        Scores.classList.add('leader');
        Scores.innerHTML = "";
        mid.appendChild(Scores);

        var Next = document.createElement('div');
        Next.innerText = ">";
        Next.classList.add('links', 'rightArrow');
        Next.addEventListener('click', function() {
            if (levelNum < $.level.length - 1 && $.gameProgress.data.scores.length > levelNum) {
                levelNum++;
                $.state.buildLevel(levelNum);
            }
            changeLevel();
        });
        customContainer.appendChild(Next);

        var Play = document.createElement('div');
        Play.classList.add('bigText', 'links');
        Play.innerHTML = "Play";
        Play.addEventListener('click', function() {
            $.playSound($.sounds['bounce3']);
            $.playSound($.sounds['bounce2']);
            document.getElementById('game').classList.remove("miaoMe");
            customContainer.innerHTML = "";
            $.state.start(levelNum);
        });
        mid.appendChild(Play);

        // 音乐设置
        if (window.AudioContext) {
            var sound = document.createElement('div');
            sound.classList.add('bigText', 'bottomRight', 'links');
            sound.innerText = "sound: " + ($.mute ? "OFF" : "ON");
            sound.addEventListener('click', function() {
                if (this.innerText === "sound: OFF") {
                    this.innerText = "sound: ON";
                    $.mute = 0;
                } else {
                    this.innerText = "sound: OFF";
                    $.mute = 1;
                }
            });
            customContainer.appendChild(sound);
        }

//        var gl = document.createElement('div');
//        gl.classList.add('bigText', 'bottomLeft', 'links');
//        gl.innerText = "Glitch: " + ($.glitch ? $.glitch : "OFF");
//        gl.addEventListener('click', function() {
//            $.glitch += 1;
//            if ($.glitch < $.glitchType.length + 1) {
//                this.innerText = "Glitch: " + $.glitch;
//                document.getElementById('cont').style.animation = $.glitchType[$.glitch - 1] + " 15s infinite alternate-reverse";
//            } else {
//                this.innerText = "Glitch: OFF";
//                $.glitch = 0;
//                document.getElementById('cont').style.animation = "";
//            }
//        });
//        customContainer.appendChild(gl);

        customContainer.appendChild(mid);


        var buildScoreBoard = function(data) {
            Scores.innerHTML = "";
            for (var i = 0; i < 5; i++) {
                if (data[i]) {
                    Scores.innerHTML += "<li><span class='list_num'>" + (i + 1) + "</span><h2>" + data[i].n + "<span class='number'>" + data[i].s + "</span></h2></li>";
                } else {
                    Scores.innerHTML += "<li><span class='list_num'>" + (i + 1) + "</span><h2>miao<span class='number'>2333.333</span></h2></li>";
                }
            }
        };


        var changeLevel = function() {

            levelName.innerHTML = "Level " + levelNum;
            ghostPath = [];

            Scores.innerHTML = "Loading...";

            if (scoreBoardType !== "online") {
                // lB.innerHTML = "<b>Local</b>";
                buildScoreBoard($.gameProgress.data.scores[levelNum] || []);
            }
        };


        this.init = function() {
            $.state.buildLevel(levelNum);
            changeLevel();
        };

        this.ghost = function() {
            return ghostPath;
        };

    }
</script>

</html>